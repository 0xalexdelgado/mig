<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>MIG Modules</title>
<meta name="author" content="Julien Vehent &lt;jvehent&#64;mozilla.com&gt;" />
<style type="text/css">

body {
  width: 95%;
  max-width: 900px;
  margin: 20px;
  padding: 0;
  background: #151515 url("../images/bkg.png") 0 0;
  color: #eaeaea;
  font: 16px;
  line-height: 1.5;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
}

/* General & 'Reset' Stuff */

.container {
  width: 95%;
  max-width: 1000px;
  margin: 0 auto;
}

section {
  display: block;
  margin: 0 0 20px 0;
}

h1, h2, h3, h4, h5, h6 {
  /*margin: 0 0 20px;*/
  margin: 0;
}

li {
  line-height: 1.4 ;
}

/* Header, <header>
 *    header   - container
 *       h1       - project name
 *          h2       - project description
 *          */

header {
  background: rgba(0, 0, 0, 0.1);
  width: 100%;
  border-bottom: 1px dashed #b5e853;
  /*padding: 20px 0;
 *   margin: 0 0 40px 0;*/
  padding: 5px 0;
  margin: 0 0 10px 0;
}

header h1 {
  font-size: 30px;
  line-height: 1.5;
  margin: 0 0 0 -40px;
  font-weight: bold;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  /*color: #b5e853;*/
  color: #089d00;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1),
               0 0 5px rgba(181, 232, 83, 0.1),
               0 0 10px rgba(181, 232, 83, 0.1);
  letter-spacing: -1px;
  -webkit-font-smoothing: antialiased;
}

header h1:before {
  content: "./ ";
  font-size: 24px;
}

header h2 {
  font-size: 18px;
  font-weight: 300;
  /*color: #666;*/
  color: #ff7800;
}

/* Main Content
 * */

#main_content {
  width: 100%;
  -webkit-font-smoothing: antialiased;
}
section img {
  max-width: 100%
}

h1, h2, h3, h4, h5, h6 {
  font-weight: normal;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  /*color: #b5e853;*/
  color: #8AB638;
  letter-spacing: -0.03em;
  /*text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1),
               0 0 5px rgba(181, 232, 83, 0.1),
               0 0 10px rgba(181, 232, 83, 0.1);*/
}

#main_content h1 {
  font-size: 30px;
}

#main_content h2 {
  font-size: 24px;
}

#main_content h3 {
  font-size: 18px;
}

#main_content h4 {
  font-size: 14px;
}

#main_content h5 {
  font-size: 12px;
  text-transform: uppercase;
  margin: 0 0 5px 0;
}

#main_content h6 {
  font-size: 12px;
  text-transform: uppercase;
  color: #999;
  margin: 0 0 5px 0;
}

dt {
  font-style: italic;
  font-weight: bold;
}
/*
ul li {
  list-style: none;
}
*/
/*
ul li:before {
  content: ">>";
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  font-size: 13px;
  color: #b5e853;
  margin-left: -37px;
  margin-right: 21px;
  line-height: 16px;
}
*/

blockquote {
  color: #aaa;
  padding-left: 10px;
  border-left: 1px dotted #666;
}


pre {
  background: rgba(0, 0, 0, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 10px;
  font-size: 14px;
  //color: #b5e853;
  border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-border-radius: 2px;
  text-wrap: normal;
  overflow: auto;
  overflow-y: hidden;
}

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
//pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment, code .c1 { color: #FF7428; }
code, pre.code .keyword, code .keyword, pre.code .kd, pre.code .kn, pre.code .k, pre.code .o { color: #00a5ff; font-weight: bold;}
pre.code .nb { color: #c45918;}
pre.code .s {color: #0a77c4;}
pre.code .punctuation, pre.code .punctuation, pre.code .p { color: white;}
pre.code .literal.string, pre.code .literal.string { color: #40BF32; }
pre.code .name.builtin, pre.code .name.builtin, pre.code .nx { color: white; }
pre.code .deleted, pre.code .deleted { background-color: #DEB0A1}
pre.code .inserted, pre.code .inserted { background-color: #A3D289}

table {
  width: 100%;
  margin: 0 0 20px 0;
}

th {
  text-align: left;
  border-bottom: 1px dashed #b5e853;
  padding: 5px 10px;
}

td {
  padding: 5px 10px;
}

hr {
  height: 0;
  border: 0;
  border-bottom: 1px dashed #b5e853;
  color: #b5e853;
}
/* Links
 *    a, a:hover, a:visited
 *    */

a {
  color: #63c0f5;
  text-shadow: 0 0 5px rgba(104, 182, 255, 0.5);
}

cite {
  color: #00FF4A;
}

strong {
  color: #C64216;
}

</style>
</head>
<body>
<div class="document" id="mig-modules">
<h1 class="title">MIG Modules</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Julien Vehent &lt;<a class="reference external" href="mailto:jvehent&#64;mozilla.com">jvehent&#64;mozilla.com</a>&gt;</td></tr>
</tbody>
</table>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#module-logic" id="id3">1&nbsp;&nbsp;&nbsp;Module logic</a><ul class="auto-toc">
<li><a class="reference internal" href="#registration" id="id4">1.1&nbsp;&nbsp;&nbsp;Registration</a></li>
<li><a class="reference internal" href="#execution" id="id5">1.2&nbsp;&nbsp;&nbsp;Execution</a><ul class="auto-toc">
<li><a class="reference internal" href="#runner-interface" id="id6">1.2.1&nbsp;&nbsp;&nbsp;Runner Interface</a></li>
<li><a class="reference internal" href="#parameters" id="id7">1.2.2&nbsp;&nbsp;&nbsp;Parameters</a></li>
<li><a class="reference internal" href="#run" id="id8">1.2.3&nbsp;&nbsp;&nbsp;Run</a></li>
<li><a class="reference internal" href="#validate-parameters" id="id9">1.2.4&nbsp;&nbsp;&nbsp;Validate Parameters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#results" id="id10">1.3&nbsp;&nbsp;&nbsp;Results</a><ul class="auto-toc">
<li><a class="reference internal" href="#success" id="id11">1.3.1&nbsp;&nbsp;&nbsp;Success</a></li>
<li><a class="reference internal" href="#foundanything" id="id12">1.3.2&nbsp;&nbsp;&nbsp;FoundAnything</a></li>
<li><a class="reference internal" href="#elements" id="id13">1.3.3&nbsp;&nbsp;&nbsp;Elements</a></li>
<li><a class="reference internal" href="#statistics" id="id14">1.3.4&nbsp;&nbsp;&nbsp;Statistics</a></li>
<li><a class="reference internal" href="#errors" id="id15">1.3.5&nbsp;&nbsp;&nbsp;Errors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#additional-interfaces" id="id16">1.4&nbsp;&nbsp;&nbsp;Additional interfaces</a><ul class="auto-toc">
<li><a class="reference internal" href="#hasresultsprinter" id="id17">1.4.1&nbsp;&nbsp;&nbsp;HasResultsPrinter</a></li>
<li><a class="reference internal" href="#hasparamscreator" id="id18">1.4.2&nbsp;&nbsp;&nbsp;HasParamsCreator</a></li>
<li><a class="reference internal" href="#hasparamsparser" id="id19">1.4.3&nbsp;&nbsp;&nbsp;HasParamsParser</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#the-example-module" id="id20">2&nbsp;&nbsp;&nbsp;The Example module</a><ul class="auto-toc">
<li><a class="reference internal" href="#headers-and-structs" id="id21">2.1&nbsp;&nbsp;&nbsp;Headers and structs</a></li>
<li><a class="reference internal" href="#id1" id="id22">2.2&nbsp;&nbsp;&nbsp;Validate Parameters</a></li>
<li><a class="reference internal" href="#id2" id="id23">2.3&nbsp;&nbsp;&nbsp;Run</a></li>
<li><a class="reference internal" href="#doing-work-and-building-results" id="id24">2.4&nbsp;&nbsp;&nbsp;Doing work and building results</a></li>
<li><a class="reference internal" href="#printing-results" id="id25">2.5&nbsp;&nbsp;&nbsp;Printing results</a></li>
<li><a class="reference internal" href="#creating-parameters" id="id26">2.6&nbsp;&nbsp;&nbsp;Creating parameters</a></li>
</ul>
</li>
</ul>
</div>
<p>In this document, we explain how modules are written and integrated into MIG.</p>
<p>The reception of a command by an agent triggers the execution of modules. A
module is a Go package that is imported into the agent at compilation, and that
performs a very specific set of tasks. For example, the <tt class="docutils literal">file</tt> module
provides a way to scan a file system for files that contain regexes, match a
checksum, ... Another module is called <tt class="docutils literal">netstat</tt>, and looks for IP addresses
currently connected to an endpoint. <tt class="docutils literal">ping</tt> is a module to ping targets from
endpoints, etc..</p>
<p>Module are somewhat autonomous. They can be developped outside of the MIG code
base, and only imported during compilation of the agent. Go does not provide a
way to load modules dynamically, so modules are compiled into the agent's static
binary, and not as separate files.</p>
<div class="section" id="module-logic">
<h1><a class="toc-backref" href="#id3">1&nbsp;&nbsp;&nbsp;Module logic</a></h1>
<div class="section" id="registration">
<h2><a class="toc-backref" href="#id4">1.1&nbsp;&nbsp;&nbsp;Registration</a></h2>
<p>A module must import <tt class="docutils literal">mig/modules</tt>.</p>
<p>A module registers itself at runtime via its <tt class="docutils literal">init()</tt> function which must
call <tt class="docutils literal">modules.Register</tt> with a module name and an instance implementing
<tt class="docutils literal">modules.Moduler</tt>:</p>
<pre class="code go literal-block">
<span class="keyword declaration">type</span> <span class="name other">Moduler</span> <span class="keyword declaration">interface</span> <span class="punctuation">{</span>
    <span class="name other">NewRun</span><span class="punctuation">()</span> <span class="name other">Runner</span>
<span class="punctuation">}</span>
</pre>
<p>A module must have a unique name. A good practice is to use the same name for
the module name as for the Go package name.  However, it is possible for a
single Go package to implement multiple modules, simply by registering
different Modulers with different names.</p>
<p>The sole method of a Moduler creates a new instance to represent a &quot;run&quot; of the
module, implementing the <tt class="docutils literal">modules.Runner</tt> interface:</p>
<pre class="code go literal-block">
<span class="keyword declaration">type</span> <span class="name other">Runner</span> <span class="keyword declaration">interface</span> <span class="punctuation">{</span>
        <span class="name other">Run</span><span class="punctuation">(</span><span class="name other">io</span><span class="punctuation">.</span><span class="name other">Reader</span><span class="punctuation">)</span> <span class="keyword type">string</span>
        <span class="name other">ValidateParameters</span><span class="punctuation">()</span> <span class="keyword type">error</span>
<span class="punctuation">}</span>
</pre>
<p>Any run-specific information should be associated with this instance and not with
the Moduler or stored in a global variable.  It should be possible for multiple
runs of the module to execute simultaneously.</p>
<p>The code sample below shows how the <tt class="docutils literal">example</tt> module uses package name
<tt class="docutils literal">example</tt> and registers with name <tt class="docutils literal">example</tt>.</p>
<pre class="code go literal-block">
<span class="keyword namespace">package</span> <span class="name other">example</span>

<span class="keyword namespace">import</span> <span class="punctuation">(</span>
        <span class="literal string">&quot;mig/modules&quot;</span>
<span class="punctuation">)</span>

<span class="comment single">// An instance of this type will represent this module; it's possible to add
// additional data fields here, although that is rarely needed.
</span><span class="keyword declaration">type</span> <span class="name other">module</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
<span class="punctuation">}</span>

<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">m</span> <span class="operator">*</span><span class="name other">module</span><span class="punctuation">)</span> <span class="name other">NewRun</span><span class="punctuation">()</span> <span class="keyword declaration">interface</span><span class="punctuation">{}</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="name builtin">new</span><span class="punctuation">(</span><span class="name other">run</span><span class="punctuation">)</span>
<span class="punctuation">}</span>

<span class="comment single">// init is called by the Go runtime at startup. We use this function to
// register the module in a global array of available modules, so the
// agent knows we exist
</span><span class="keyword declaration">func</span> <span class="name other">init</span><span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Register</span><span class="punctuation">(</span><span class="literal string">&quot;example&quot;</span><span class="punctuation">,</span> <span class="name builtin">new</span><span class="punctuation">(</span><span class="name other">module</span><span class="punctuation">))</span>
<span class="punctuation">}</span>

<span class="keyword declaration">type</span> <span class="name other">run</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">Parameters</span> <span class="name other">params</span>
        <span class="name other">Results</span>    <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Result</span>
<span class="punctuation">}</span>
</pre>
<p><tt class="docutils literal">init()</tt> is a go builtin function that is executed automatically in all
imported packages when a program starts. In the agents, modules are imported
anonymously, which means that their <tt class="docutils literal">init()</tt> function will be executed even if
the modules are unused in the agent. Therefore, when MIG Agent starts, all
modules execute their <tt class="docutils literal">init()</tt> function, add their names and runner function to
the global list of available module, and stop there.</p>
<p>The list of modules imported in the agent is maintained in
<tt class="docutils literal">conf/available_modules.go</tt>. You should use this file to add or remove modules.</p>
<pre class="code go literal-block">
<span class="keyword namespace">import</span> <span class="punctuation">(</span>
        <span class="comment single">//_ &quot;mig/modules/example&quot;
</span>        <span class="name other">_</span> <span class="literal string">&quot;mig/modules/agentdestroy&quot;</span>
        <span class="name other">_</span> <span class="literal string">&quot;mig/modules/file&quot;</span>
        <span class="name other">_</span> <span class="literal string">&quot;mig/modules/netstat&quot;</span>
        <span class="name other">_</span> <span class="literal string">&quot;mig/modules/timedrift&quot;</span>
        <span class="comment single">//_ &quot;mig/modules/upgrade&quot;
</span>        <span class="name other">_</span> <span class="literal string">&quot;mig/modules/ping&quot;</span>
<span class="punctuation">)</span>
</pre>
</div>
<div class="section" id="execution">
<h2><a class="toc-backref" href="#id5">1.2&nbsp;&nbsp;&nbsp;Execution</a></h2>
<p>When the agent receives a command to execute, it looks up modules in
the global list <tt class="docutils literal">modules.Available</tt>, and if a module is registered to execute
the command, calls its runner function to get a new instance representing the run,
and then calls that instance's <tt class="docutils literal">Run</tt> method.</p>
<div class="section" id="runner-interface">
<h3><a class="toc-backref" href="#id6">1.2.1&nbsp;&nbsp;&nbsp;Runner Interface</a></h3>
<p>A mig module typically defines its own <tt class="docutils literal">run</tt> struct implementing the
<tt class="docutils literal">modules.Runner</tt> interface and representing a single run of the module.  The
<tt class="docutils literal">run</tt> struct typically contains two fields: module parameters and module results.
The former is any format the module choses to use, while the latter generally
implements the <tt class="docutils literal">modules.Result</tt> struct (note that this is not required, but
it is the easiest way to return a properly-formatted JSON result).</p>
<pre class="code go literal-block">
<span class="keyword declaration">type</span> <span class="name other">run</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">Parameters</span> <span class="name other">myModuleParams</span>
        <span class="name other">Results</span>    <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Result</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="parameters">
<h3><a class="toc-backref" href="#id7">1.2.2&nbsp;&nbsp;&nbsp;Parameters</a></h3>
<p>When a module is available to run an operation, the agent passes the operation
parameters to the module.</p>
<p>The easiest way to see this is to invoke the agent binary
with the flag <strong>-m</strong>, followed by the name of the module:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>mig-agent -m example <span class="operator">&lt;&lt;&lt;</span> <span class="literal string single">'{&quot;class&quot;:&quot;parameters&quot;, &quot;parameters&quot;:{&quot;gethostname&quot;: true, &quot;getaddresses&quot;: true, &quot;lookuphost&quot;: [&quot;www.google.com&quot;]}}'</span>
<span class="operator">[</span>info<span class="operator">]</span> using <span class="name builtin">builtin </span>conf
<span class="operator">{</span><span class="literal string double">&quot;foundanything&quot;</span>:true,<span class="literal string double">&quot;success&quot;</span>:true,<span class="literal string double">&quot;elements&quot;</span>:<span class="operator">{</span><span class="literal string double">&quot;hostname&quot;</span>:<span class="literal string double">&quot;fedbox2.jaffa.linuxwall.info&quot;</span>,<span class="literal string double">&quot;addresses&quot;</span>:<span class="operator">[</span><span class="literal string double">&quot;172.21.0.3/20&quot;</span>,<span class="literal string double">&quot;fe80::8e70:5aff:fec8:be50/64&quot;</span><span class="operator">]</span>,<span class="literal string double">&quot;lookeduphost&quot;</span>:<span class="operator">{</span><span class="literal string double">&quot;www.google.com&quot;</span>:<span class="operator">[</span><span class="literal string double">&quot;74.125.196.105&quot;</span>,<span class="literal string double">&quot;74.125.196.147&quot;</span>,<span class="literal string double">&quot;74.125.196.106&quot;</span>,<span class="literal string double">&quot;74.125.196.104&quot;</span>,<span class="literal string double">&quot;74.125.196.103&quot;</span>,<span class="literal string double">&quot;74.125.196.99&quot;</span>,<span class="literal string double">&quot;2607:f8b0:4002:c07::6a&quot;</span><span class="operator">]}}</span>,<span class="literal string double">&quot;statistics&quot;</span>:<span class="operator">{</span><span class="literal string double">&quot;stufffound&quot;</span>:3<span class="operator">}</span>,<span class="literal string double">&quot;errors&quot;</span>:null<span class="operator">}</span>
</pre>
<p>The module receives this JSON input as an <tt class="docutils literal">io.Reader</tt> passed to its <tt class="docutils literal">Run</tt> method.</p>
</div>
<div class="section" id="run">
<h3><a class="toc-backref" href="#id8">1.2.3&nbsp;&nbsp;&nbsp;Run</a></h3>
<p>The module's <tt class="docutils literal">Run</tt> method should start by trying to read parameters from the
given <tt class="docutils literal">in io.Reader</tt>. It then validates the parameters against its own
formatting rules, performs work and returns results in a JSON string.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">Run</span><span class="punctuation">(</span><span class="name other">in</span> <span class="name other">io</span><span class="punctuation">.</span><span class="name other">Reader</span><span class="punctuation">)</span> <span class="keyword type">string</span> <span class="punctuation">{</span>
        <span class="keyword">defer</span> <span class="keyword declaration">func</span><span class="punctuation">()</span> <span class="punctuation">{</span>
                <span class="keyword">if</span> <span class="name other">e</span> <span class="operator">:=</span> <span class="name builtin">recover</span><span class="punctuation">();</span> <span class="name other">e</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Errors</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Errors</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;%v&quot;</span><span class="punctuation">,</span> <span class="name other">e</span><span class="punctuation">))</span>
                        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Success</span> <span class="punctuation">=</span> <span class="keyword constant">false</span>
                        <span class="name other">buf</span><span class="punctuation">,</span> <span class="name other">_</span> <span class="operator">:=</span> <span class="name other">json</span><span class="punctuation">.</span><span class="name other">Marshal</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">)</span>
                        <span class="name other">out</span> <span class="punctuation">=</span> <span class="name builtin">string</span><span class="punctuation">(</span><span class="name other">buf</span><span class="punctuation">[:])</span>
                <span class="punctuation">}</span>
        <span class="punctuation">}()</span>

        <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">ReadInputParameters</span><span class="punctuation">(</span><span class="name other">in</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>

        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">ValidateParameters</span><span class="punctuation">()</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>

        <span class="keyword">return</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">doModuleStuff</span><span class="punctuation">()</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">defer</tt> block in the sample above is used to catch potential panics and
return a nicely formatted JSON error to the agent. This is a clean way to
indicate to the MIG platform that the module has failed to run on this agent.</p>
</div>
<div class="section" id="validate-parameters">
<h3><a class="toc-backref" href="#id9">1.2.4&nbsp;&nbsp;&nbsp;Validate Parameters</a></h3>
<p>A module must implement the <tt class="docutils literal">ValidateParameters()</tt> method.</p>
<p>The role of that interface is to go through the parameters supplied to <tt class="docutils literal">Run</tt>
and verify that they follow a format expected by the module.  This method is
useful during <tt class="docutils literal">Run</tt> but is not called from outside the module.</p>
<p>Go is strongly typed, so there's no risk of finding a string when a float is
expected. However, this function should verify that values are in a proper
range, that regular expressions compile without errors, or that string
parameters use the correct syntax.</p>
<p>When validation fails, an error with a descriptive validation failure must be
returned to the caller.</p>
<p>A good example of validating parameters can be found in the <tt class="docutils literal">file</tt> module at
<a class="reference external" href="https://github.com/mozilla/mig/blob/master/src/mig/modules/file/file.go">https://github.com/mozilla/mig/blob/master/src/mig/modules/file/file.go</a></p>
</div>
</div>
<div class="section" id="results">
<h2><a class="toc-backref" href="#id10">1.3&nbsp;&nbsp;&nbsp;Results</a></h2>
<p>Results must follow a specific format defined in <tt class="docutils literal">modules.Result</tt>. Some rules
apply to the way fields in this struct must be set.</p>
<pre class="code go literal-block">
<span class="keyword declaration">type</span> <span class="name other">Result</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">Success</span>       <span class="keyword type">bool</span>        <span class="literal string">`json:&quot;success&quot;`</span>
        <span class="name other">FoundAnything</span> <span class="keyword type">bool</span>        <span class="literal string">`json:&quot;foundanything&quot;`</span>
        <span class="name other">Elements</span>      <span class="keyword declaration">interface</span><span class="punctuation">{}</span> <span class="literal string">`json:&quot;elements&quot;`</span>
        <span class="name other">Statistics</span>    <span class="keyword declaration">interface</span><span class="punctuation">{}</span> <span class="literal string">`json:&quot;statistics&quot;`</span>
        <span class="name other">Errors</span>        <span class="punctuation">[]</span><span class="keyword type">string</span>    <span class="literal string">`json:&quot;errors&quot;`</span>
<span class="punctuation">}</span>
</pre>
<div class="section" id="success">
<h3><a class="toc-backref" href="#id11">1.3.1&nbsp;&nbsp;&nbsp;Success</a></h3>
<p><tt class="docutils literal">Success</tt> must inform the investigator if the module has failed to complete its
execution. It must be set to <tt class="docutils literal">true</tt> only if the module has ran successfully. It
does not indicate anything about the results returned by the module, just that
it ran and finished.</p>
</div>
<div class="section" id="foundanything">
<h3><a class="toc-backref" href="#id12">1.3.2&nbsp;&nbsp;&nbsp;FoundAnything</a></h3>
<p><tt class="docutils literal">FoundAnything</tt> must be set to <tt class="docutils literal">true</tt> only when the module was tasked with
finding something, and at least one instance of that something was found. If
the module searched for multiple things, one find is enough to set this flag to
true. The goal is to indicate to the investigator that the results from this
agent need closer scrutiny.</p>
</div>
<div class="section" id="elements">
<h3><a class="toc-backref" href="#id13">1.3.3&nbsp;&nbsp;&nbsp;Elements</a></h3>
<p><tt class="docutils literal">Elements</tt> contains raw results from the module. This is defined as an
interface, which means that each module must define the format of the results
returned to the MIG platform. The only rule here is that <strong>modules must never
return raw data to investigators</strong>. Metadata is fine, but file contents or
memory dumps are not something MIG should be transporting ever.</p>
</div>
<div class="section" id="statistics">
<h3><a class="toc-backref" href="#id14">1.3.4&nbsp;&nbsp;&nbsp;Statistics</a></h3>
<p><tt class="docutils literal">Statistics</tt> is an optional struct that can contain stats about the execution
of the module. For example, the <tt class="docutils literal">file</tt> module returns the numbers of files
inspected by a given search, as well as the time it took to run the
investigation. That information is often useful for investigators.</p>
</div>
<div class="section" id="errors">
<h3><a class="toc-backref" href="#id15">1.3.5&nbsp;&nbsp;&nbsp;Errors</a></h3>
<p><tt class="docutils literal">Errors</tt> is an array of string that can contain soft and hard errors. If the
module failed to run, <tt class="docutils literal">Success</tt> would be set to <tt class="docutils literal">false</tt> and <tt class="docutils literal">Errors</tt> would
contain a single error with the description of the failure. If the module
succeeded to run, then <tt class="docutils literal">Errors</tt> could contain soft failures that did not
prevent the module from finishing, but may be useful for the investigator to
know about. For example, if the <tt class="docutils literal">memory</tt> module fails to inspect a given memory
region, the <tt class="docutils literal">Errors</tt> array could contain an entry providing that information.</p>
</div>
</div>
<div class="section" id="additional-interfaces">
<h2><a class="toc-backref" href="#id16">1.4&nbsp;&nbsp;&nbsp;Additional interfaces</a></h2>
<div class="section" id="hasresultsprinter">
<h3><a class="toc-backref" href="#id17">1.4.1&nbsp;&nbsp;&nbsp;HasResultsPrinter</a></h3>
<p><tt class="docutils literal">HasResultsPrinter</tt> is an interface used to allow a module to implement
the <strong>PrintResults()</strong> function. <tt class="docutils literal">PrintResults()</tt> is a pretty-printer used to display
the results of a module as an array of string. It is defined as a module-specific
interface because only the module knows how to parse its <tt class="docutils literal">Elements</tt> and
<tt class="docutils literal">Statistics</tt> interfaces in <tt class="docutils literal">modules.Result</tt>.</p>
<p>The interface is defined as:</p>
<pre class="code go literal-block">
<span class="comment single">// HasResultsPrinter implements functions used by module to print information
</span><span class="keyword declaration">type</span> <span class="name other">HasResultsPrinter</span> <span class="keyword declaration">interface</span> <span class="punctuation">{</span>
        <span class="name other">PrintResults</span><span class="punctuation">(</span><span class="name other">result</span> <span class="name other">Result</span><span class="punctuation">,</span> <span class="name other">showResultsOnly</span> <span class="keyword type">bool</span><span class="punctuation">)</span> <span class="punctuation">([]</span><span class="keyword type">string</span><span class="punctuation">,</span> <span class="keyword type">error</span><span class="punctuation">)</span>
<span class="punctuation">}</span>
</pre>
<p>A typical implementation of <tt class="docutils literal">PrintResults</tt> takes a <tt class="docutils literal">modules.Result</tt> struct and
a boolean that indicates whether the printer should display errors and
statistics or only found results. When that boolean is set to <tt class="docutils literal">true</tt>, errors, stats
and empty results are <strong>not</strong> displayed.  Note that the <tt class="docutils literal">result</tt> argument is
the result of unmarhsalling the marhsalled value returned from the <tt class="docutils literal">Run</tt> method.</p>
<p>The function returns results into an array of strings.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">PrintResults</span><span class="punctuation">(</span><span class="name other">result</span> <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Result</span><span class="punctuation">,</span> <span class="name other">matchOnly</span> <span class="keyword type">bool</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name other">prints</span> <span class="punctuation">[]</span><span class="keyword type">string</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="keyword type">error</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword declaration">var</span> <span class="punctuation">(</span>
                <span class="name other">el</span>    <span class="name other">elements</span>
                <span class="name other">stats</span> <span class="name other">statistics</span>
        <span class="punctuation">)</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">GetElements</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">el</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>

        <span class="punctuation">[</span><span class="operator">...</span> <span class="name other">add</span> <span class="name other">things</span> <span class="name other">into</span> <span class="name other">the</span> <span class="name other">prints</span> <span class="name other">array</span> <span class="operator">...</span><span class="punctuation">]</span>

        <span class="keyword">if</span> <span class="name other">matchOnly</span> <span class="punctuation">{</span>
                <span class="keyword">return</span> <span class="comment single">// stop here
</span>        <span class="punctuation">}</span>
        <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">e</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">Errors</span> <span class="punctuation">{</span>
                <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;error: %v&quot;</span><span class="punctuation">,</span> <span class="name other">e</span><span class="punctuation">))</span>
        <span class="punctuation">}</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">GetStatistics</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">stats</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="punctuation">[</span><span class="operator">...</span> <span class="name other">add</span> <span class="name other">stats</span> <span class="name other">into</span> <span class="name other">the</span> <span class="name other">prints</span> <span class="name other">array</span> <span class="operator">...</span><span class="punctuation">]</span>
        <span class="keyword">return</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="hasparamscreator">
<h3><a class="toc-backref" href="#id18">1.4.2&nbsp;&nbsp;&nbsp;HasParamsCreator</a></h3>
<p><tt class="docutils literal">HasParamsCreator</tt> implements the <tt class="docutils literal">ParamsCreator()</tt> function used to provide
interactive parameters creation in the MIG Console. The function does not take
any input value, but implements a terminal prompt for the investigator to
fill up the module parameters. The function returns a Parameters structure
that the MIG Console will add into an Action.</p>
<p>It can be implemented in various ways, as long as it prompt the user in the
terminal using something like <tt class="docutils literal">fmt.Scanln()</tt>.</p>
<p>The interface is defined as:</p>
<pre class="code go literal-block">
<span class="keyword declaration">type</span> <span class="name other">HasParamsCreator</span> <span class="keyword declaration">interface</span> <span class="punctuation">{</span>
        <span class="name other">ParamsCreator</span><span class="punctuation">()</span> <span class="punctuation">(</span><span class="keyword declaration">interface</span><span class="punctuation">{},</span> <span class="keyword type">error</span><span class="punctuation">)</span>
<span class="punctuation">}</span>
</pre>
<p>A module implementation would have the function:</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">ParamsCreator</span><span class="punctuation">()</span> <span class="punctuation">(</span><span class="keyword declaration">interface</span><span class="punctuation">{},</span> <span class="keyword type">error</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Println</span><span class="punctuation">(</span><span class="literal string">&quot;initializing netstat parameters creation&quot;</span><span class="punctuation">)</span>
        <span class="keyword declaration">var</span> <span class="name other">err</span> <span class="keyword type">error</span>
        <span class="keyword declaration">var</span> <span class="name other">p</span> <span class="name other">params</span>
        <span class="name other">printHelp</span><span class="punctuation">(</span><span class="keyword constant">false</span><span class="punctuation">)</span>
        <span class="name other">scanner</span> <span class="operator">:=</span> <span class="name other">bufio</span><span class="punctuation">.</span><span class="name other">NewScanner</span><span class="punctuation">(</span><span class="name other">os</span><span class="punctuation">.</span><span class="name other">Stdin</span><span class="punctuation">)</span>
        <span class="keyword">for</span> <span class="punctuation">{</span>
                <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Printf</span><span class="punctuation">(</span><span class="literal string">&quot;drift&gt; &quot;</span><span class="punctuation">)</span>
                <span class="name other">scanner</span><span class="punctuation">.</span><span class="name other">Scan</span><span class="punctuation">()</span>
                <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">scanner</span><span class="punctuation">.</span><span class="name other">Err</span><span class="punctuation">();</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Println</span><span class="punctuation">(</span><span class="literal string">&quot;Invalid input. Try again&quot;</span><span class="punctuation">)</span>
                        <span class="keyword">continue</span>
                <span class="punctuation">}</span>
                <span class="name other">input</span> <span class="operator">:=</span> <span class="name other">scanner</span><span class="punctuation">.</span><span class="name other">Text</span><span class="punctuation">()</span>
                <span class="keyword">if</span> <span class="name other">input</span> <span class="operator">==</span> <span class="literal string">&quot;help&quot;</span> <span class="punctuation">{</span>
                        <span class="name other">printHelp</span><span class="punctuation">(</span><span class="keyword constant">false</span><span class="punctuation">)</span>
                        <span class="keyword">continue</span>
                <span class="punctuation">}</span>
                <span class="keyword">if</span> <span class="name other">input</span> <span class="operator">!=</span> <span class="literal string">&quot;&quot;</span> <span class="punctuation">{</span>
                        <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">time</span><span class="punctuation">.</span><span class="name other">ParseDuration</span><span class="punctuation">(</span><span class="name other">input</span><span class="punctuation">)</span>
                        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                                <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Println</span><span class="punctuation">(</span><span class="literal string">&quot;invalid drift duration. try again. ex: drift&gt; 5s&quot;</span><span class="punctuation">)</span>
                                <span class="keyword">continue</span>
                        <span class="punctuation">}</span>
                <span class="punctuation">}</span>
                <span class="name other">p</span><span class="punctuation">.</span><span class="name other">Drift</span> <span class="punctuation">=</span> <span class="name other">input</span>
                <span class="keyword">break</span>
        <span class="punctuation">}</span>
        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span> <span class="punctuation">=</span> <span class="name other">p</span>
        <span class="keyword">return</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">,</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">ValidateParameters</span><span class="punctuation">()</span>
<span class="punctuation">}</span>
</pre>
<p>It is highly recommend to call <tt class="docutils literal">ValidateParameters</tt> to verify that the
parameters supplied by the users are correct.</p>
</div>
<div class="section" id="hasparamsparser">
<h3><a class="toc-backref" href="#id19">1.4.3&nbsp;&nbsp;&nbsp;HasParamsParser</a></h3>
<p><tt class="docutils literal">HasParamsParser</tt> is similar to <tt class="docutils literal">HasParamsCreator</tt>, but implements a command
line parameters parser instead of an interactive prompt. It is used by the MIG
command line to parse module-specific flags into module Parameters. Each module
must implement <tt class="docutils literal">ParamsParser()</tt> to transform an array of string into a
parameters interface. The recommended way to implement it is to use <tt class="docutils literal">FlagSet</tt>
from the <tt class="docutils literal">flag</tt> Go package.
The interface is defined as:</p>
<pre class="code go literal-block">
<span class="comment single">// HasParamsParser implements a function that parses command line parameters
</span><span class="keyword declaration">type</span> <span class="name other">HasParamsParser</span> <span class="keyword declaration">interface</span> <span class="punctuation">{</span>
        <span class="name other">ParamsParser</span><span class="punctuation">([]</span><span class="keyword type">string</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="keyword declaration">interface</span><span class="punctuation">{},</span> <span class="keyword type">error</span><span class="punctuation">)</span>
<span class="punctuation">}</span>
</pre>
<p>A typical implementation from the <tt class="docutils literal">timedrift</tt> module looks as follows:</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">ParamsParser</span><span class="punctuation">(</span><span class="name other">args</span> <span class="punctuation">[]</span><span class="keyword type">string</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="keyword declaration">interface</span><span class="punctuation">{},</span> <span class="keyword type">error</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword declaration">var</span> <span class="punctuation">(</span>
                <span class="name other">err</span>   <span class="keyword type">error</span>
                <span class="name other">drift</span> <span class="keyword type">string</span>
                <span class="name other">fs</span>    <span class="name other">flag</span><span class="punctuation">.</span><span class="name other">FlagSet</span>
        <span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name other">args</span><span class="punctuation">)</span> <span class="operator">&gt;=</span> <span class="literal number integer">1</span> <span class="operator">&amp;&amp;</span> <span class="name other">args</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">==</span> <span class="literal string">&quot;help&quot;</span> <span class="punctuation">{</span>
                <span class="name other">printHelp</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">)</span>
                <span class="keyword">return</span> <span class="keyword constant">nil</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Errorf</span><span class="punctuation">(</span><span class="literal string">&quot;help printed&quot;</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name other">args</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="literal number integer">0</span> <span class="punctuation">{</span>
                <span class="keyword">return</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">,</span> <span class="keyword constant">nil</span>
        <span class="punctuation">}</span>
        <span class="name other">fs</span><span class="punctuation">.</span><span class="name other">Init</span><span class="punctuation">(</span><span class="literal string">&quot;time&quot;</span><span class="punctuation">,</span> <span class="name other">flag</span><span class="punctuation">.</span><span class="name other">ContinueOnError</span><span class="punctuation">)</span>
        <span class="name other">fs</span><span class="punctuation">.</span><span class="name other">StringVar</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">drift</span><span class="punctuation">,</span> <span class="literal string">&quot;drift&quot;</span><span class="punctuation">,</span> <span class="literal string">&quot;&quot;</span><span class="punctuation">,</span> <span class="literal string">&quot;see help&quot;</span><span class="punctuation">)</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">fs</span><span class="punctuation">.</span><span class="name other">Parse</span><span class="punctuation">(</span><span class="name other">args</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="keyword">return</span> <span class="keyword constant">nil</span><span class="punctuation">,</span> <span class="name other">err</span>
        <span class="punctuation">}</span>
        <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">time</span><span class="punctuation">.</span><span class="name other">ParseDuration</span><span class="punctuation">(</span><span class="name other">drift</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="keyword">return</span> <span class="keyword constant">nil</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Errorf</span><span class="punctuation">(</span><span class="literal string">&quot;invalid drift duration. try help.&quot;</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">.</span><span class="name other">Drift</span> <span class="punctuation">=</span> <span class="name other">drift</span>
        <span class="keyword">return</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">,</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">ValidateParameters</span><span class="punctuation">()</span>
<span class="punctuation">}</span>
</pre>
<p>It is highly recommend to call <tt class="docutils literal">ValidateParameters</tt> to verify that the
parameters supplied by the users are correct.</p>
</div>
</div>
</div>
<div class="section" id="the-example-module">
<h1><a class="toc-backref" href="#id20">2&nbsp;&nbsp;&nbsp;The Example module</a></h1>
<p>An example module that can be used as a template is available in
<a class="reference external" href="https://github.com/mozilla/mig/blob/master/src/mig/modules/example/example.go">src/mig/modules/example/</a>. We will study its structure to understand how
modules are written and executed.</p>
<div class="section" id="headers-and-structs">
<h2><a class="toc-backref" href="#id21">2.1&nbsp;&nbsp;&nbsp;Headers and structs</a></h2>
<p>The first part of the module takes care of the registration and declaration of
needed structs.</p>
<pre class="code go literal-block">
<span class="keyword namespace">package</span> <span class="name other">example</span>

<span class="keyword namespace">import</span> <span class="punctuation">(</span>
        <span class="literal string">&quot;encoding/json&quot;</span>
        <span class="literal string">&quot;fmt&quot;</span>
        <span class="literal string">&quot;mig/modules&quot;</span>
        <span class="literal string">&quot;net&quot;</span>
        <span class="literal string">&quot;os&quot;</span>
        <span class="literal string">&quot;regexp&quot;</span>
<span class="punctuation">)</span>

<span class="comment single">// init is called by the Go runtime at startup. We use this function to
// register the module in a global array of available modules, so the
// agent knows we exist
</span><span class="keyword declaration">func</span> <span class="name other">init</span><span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Register</span><span class="punctuation">(</span><span class="literal string">&quot;example&quot;</span><span class="punctuation">,</span> <span class="keyword declaration">func</span><span class="punctuation">()</span> <span class="keyword declaration">interface</span><span class="punctuation">{}</span> <span class="punctuation">{</span>
                <span class="keyword">return</span> <span class="name builtin">new</span><span class="punctuation">(</span><span class="name other">run</span><span class="punctuation">)</span>
        <span class="punctuation">})</span>
<span class="punctuation">}</span>

<span class="keyword declaration">type</span> <span class="name other">run</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">Parameters</span> <span class="name other">params</span>
        <span class="name other">Results</span>    <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Result</span>
<span class="punctuation">}</span>

<span class="comment single">// a simple parameters structure, the format is arbitrary
</span><span class="keyword declaration">type</span> <span class="name other">params</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">GetHostname</span>  <span class="keyword type">bool</span>     <span class="literal string">`json:&quot;gethostname&quot;`</span>
        <span class="name other">GetAddresses</span> <span class="keyword type">bool</span>     <span class="literal string">`json:&quot;getaddresses&quot;`</span>
        <span class="name other">LookupHost</span>   <span class="punctuation">[]</span><span class="keyword type">string</span> <span class="literal string">`json:&quot;lookuphost&quot;`</span>
<span class="punctuation">}</span>

<span class="keyword declaration">type</span> <span class="name other">elements</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">Hostname</span>     <span class="keyword type">string</span>              <span class="literal string">`json:&quot;hostname,omitempty&quot;`</span>
        <span class="name other">Addresses</span>    <span class="punctuation">[]</span><span class="keyword type">string</span>            <span class="literal string">`json:&quot;addresses,omitempty&quot;`</span>
        <span class="name other">LookedUpHost</span> <span class="keyword declaration">map</span><span class="punctuation">[</span><span class="keyword type">string</span><span class="punctuation">][]</span><span class="keyword type">string</span> <span class="literal string">`json:&quot;lookeduphost,omitempty&quot;`</span>
<span class="punctuation">}</span>

<span class="keyword declaration">type</span> <span class="name other">statistics</span> <span class="keyword declaration">struct</span> <span class="punctuation">{</span>
        <span class="name other">StuffFound</span> <span class="keyword type">int64</span> <span class="literal string">`json:&quot;stufffound&quot;`</span>
<span class="punctuation">}</span>
</pre>
<p>Three custom structs are defined: <tt class="docutils literal">params</tt>, <tt class="docutils literal">elements</tt> and <tt class="docutils literal">statistics</tt>.</p>
<p><tt class="docutils literal">params</tt> implements custom module parameters. In this instance, the module will
access two booleans (<tt class="docutils literal">GetHostname</tt> and <tt class="docutils literal">GetAddresses</tt>), and one array of
strings (<tt class="docutils literal">LookupHost</tt>). We have decided that this module will return its
hostname if <tt class="docutils literal">GetHostname</tt> is set to true. It will return its IP addresses if
<tt class="docutils literal">GetAddresses</tt> is set to true, and it will perform DNS lookups and return the
IP addresses of each FQDN listed in the <tt class="docutils literal">LookupHost</tt> array.</p>
<p><tt class="docutils literal">elements</tt> will contain the results found by the module. The hostname will go
into <tt class="docutils literal">elements.Hostname</tt>. The local addresses will be appended into
<tt class="docutils literal">elements.Addresses</tt>. And each host that was looked up will be added into the
<tt class="docutils literal">elements.LookedUpHost</tt> map with their own arrays of IP addresses.</p>
<p><tt class="docutils literal">statistics</tt> just keeps a counter of stuffs that was found. We could also add
an execution timer in this struct to indicate how look it took the module to
run.</p>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id22">2.2&nbsp;&nbsp;&nbsp;Validate Parameters</a></h2>
<p>Next we'll implement a parameters validation function.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">ValidateParameters</span><span class="punctuation">()</span> <span class="punctuation">(</span><span class="name other">err</span> <span class="keyword type">error</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name other">fqdn</span> <span class="operator">:=</span> <span class="name other">regexp</span><span class="punctuation">.</span><span class="name other">MustCompilePOSIX</span><span class="punctuation">(</span><span class="literal string">`^([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(\.([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*$`</span><span class="punctuation">)</span>
        <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">host</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">.</span><span class="name other">LookupHost</span> <span class="punctuation">{</span>
                <span class="keyword">if</span> <span class="punctuation">!</span><span class="name other">fqdn</span><span class="punctuation">.</span><span class="name other">MatchString</span><span class="punctuation">(</span><span class="name other">host</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                        <span class="keyword">return</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Errorf</span><span class="punctuation">(</span><span class="literal string">&quot;ValidateParameters: LookupHost parameter is not a valid FQDN.&quot;</span><span class="punctuation">)</span>
                <span class="punctuation">}</span>
        <span class="punctuation">}</span>
        <span class="keyword">return</span>
<span class="punctuation">}</span>
</pre>
<p>Since our parameters struct is very basic, there is little verification to do.
The two booleans don't need verification, because Go is strongly typed. But we
attempt to validate the FQDN of hosts that need to be looked up with a regular
expression. If the validation fails, <tt class="docutils literal">ValidateParameters</tt> returns an error.</p>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id23">2.3&nbsp;&nbsp;&nbsp;Run</a></h2>
<p>Run is what the agent will call when the module is executed. It starts by
defining a panic handling routine that will transform panics into
<tt class="docutils literal">modules.Result.Errors</tt> and return the JSON.</p>
<p>Then, <tt class="docutils literal">Run()</tt> reads parameters from stdin. The call to <tt class="docutils literal">modules.ReadInputParameters</tt>
will block until one line of input is received. If what was received isn't
valid parameters, it panics.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">Run</span><span class="punctuation">(</span><span class="name other">in</span> <span class="name other">io</span><span class="punctuation">.</span><span class="name other">Reader</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name other">out</span> <span class="keyword type">string</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">defer</span> <span class="keyword declaration">func</span><span class="punctuation">()</span> <span class="punctuation">{</span>
                <span class="keyword">if</span> <span class="name other">e</span> <span class="operator">:=</span> <span class="name builtin">recover</span><span class="punctuation">();</span> <span class="name other">e</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Errors</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Errors</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;%v&quot;</span><span class="punctuation">,</span> <span class="name other">e</span><span class="punctuation">))</span>
                        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Success</span> <span class="punctuation">=</span> <span class="keyword constant">false</span>
                        <span class="name other">buf</span><span class="punctuation">,</span> <span class="name other">_</span> <span class="operator">:=</span> <span class="name other">json</span><span class="punctuation">.</span><span class="name other">Marshal</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">)</span>
                        <span class="name other">out</span> <span class="punctuation">=</span> <span class="name builtin">string</span><span class="punctuation">(</span><span class="name other">buf</span><span class="punctuation">[:])</span>
                <span class="punctuation">}</span>
        <span class="punctuation">}()</span>

        <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">ReadInputParameters</span><span class="punctuation">(</span><span class="name other">in</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">ValidateParameters</span><span class="punctuation">()</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>

        <span class="name other">moduleDone</span> <span class="operator">:=</span> <span class="name builtin">make</span><span class="punctuation">(</span><span class="keyword declaration">chan</span> <span class="keyword type">bool</span><span class="punctuation">)</span>
        <span class="name other">stop</span> <span class="operator">:=</span> <span class="name builtin">make</span><span class="punctuation">(</span><span class="keyword declaration">chan</span> <span class="keyword type">bool</span><span class="punctuation">)</span>
        <span class="keyword">go</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">doModuleStuff</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">out</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name other">moduleDone</span><span class="punctuation">)</span>
        <span class="keyword">go</span> <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">WatchForStop</span><span class="punctuation">(</span><span class="name other">in</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name other">stop</span><span class="punctuation">)</span>

        <span class="keyword">select</span> <span class="punctuation">{</span>
        <span class="keyword">case</span> <span class="operator">&lt;-</span><span class="name other">moduleDone</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="name other">out</span>
        <span class="keyword">case</span> <span class="operator">&lt;-</span><span class="name other">stop</span><span class="punctuation">:</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="literal string">&quot;stop message received, terminating early&quot;</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>What happens after is a little tricky to follow. We want the module to do work,
but we also want to allow the investigator to kill the module early if needed.
So we first send the module to perform the work by calling <tt class="docutils literal">go <span class="pre">r.doModuleStuff(&amp;out,</span> &amp;moduleDone)</tt>
where <tt class="docutils literal">&amp;out</tt> is a pointer to the string that <tt class="docutils literal">Run()</tt> will return, and
<tt class="docutils literal">&amp;moduleDone</tt> is a channel that will receive a boolean when the module is done
doing stuff.</p>
<p>Meanwhile, we start another goroutine <tt class="docutils literal">go modules.WatchForStop(in, &amp;stop)</tt> that
will continously read the standard input of the module. If a <tt class="docutils literal">stop</tt> message is
received on the standard input, the goroutine inserts a boolean in the <tt class="docutils literal">stop</tt>
channel. This method is typically used by the agent to ask a module to shutdown.</p>
<p>Both routines are running in parallel, and we use a <tt class="docutils literal">select {case}</tt> to detect
the first one that has activity. If the module is done, <tt class="docutils literal">Run()</tt> exits normally
by returning the value of <tt class="docutils literal">out</tt>. But if a stop message is received, then
<tt class="docutils literal">Run()</tt> panics, which will generate a nicely formatted error in the defer block.</p>
</div>
<div class="section" id="doing-work-and-building-results">
<h2><a class="toc-backref" href="#id24">2.4&nbsp;&nbsp;&nbsp;Doing work and building results</a></h2>
<p><tt class="docutils literal">doModuleStuff</tt> and <tt class="docutils literal">buildResults</tt> are two module specific functions that
perform the core of the module work. Their implementation is completely
arbitrary. The only requirement is that the data returned is a JSON marshalled
string of the struct <tt class="docutils literal">modules.Result</tt>.</p>
<p>In the sample below, the variables <tt class="docutils literal">el</tt> and <tt class="docutils literal">stats</tt> implement the <tt class="docutils literal">elements</tt>
and <tt class="docutils literal">statistics</tt> types defined previously. Results are stored in these two
variables, then copied into results alongside potential errors.</p>
<p>Note in <tt class="docutils literal">buildResults</tt> the way <tt class="docutils literal">FoundAnything</tt> and <tt class="docutils literal">Success</tt> are set to
implement the rules defined earlier in this page.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">doModuleStuff</span><span class="punctuation">(</span><span class="name other">out</span> <span class="operator">*</span><span class="keyword type">string</span><span class="punctuation">,</span> <span class="name other">moduleDone</span> <span class="operator">*</span><span class="keyword declaration">chan</span> <span class="keyword type">bool</span><span class="punctuation">)</span> <span class="keyword type">error</span> <span class="punctuation">{</span>
        <span class="keyword declaration">var</span> <span class="punctuation">(</span>
                <span class="name other">el</span>    <span class="name other">elements</span>
                <span class="name other">stats</span> <span class="name other">statistics</span>
        <span class="punctuation">)</span>
        <span class="name other">el</span><span class="punctuation">.</span><span class="name other">LookedUpHost</span> <span class="punctuation">=</span> <span class="name builtin">make</span><span class="punctuation">(</span><span class="keyword declaration">map</span><span class="punctuation">[</span><span class="keyword type">string</span><span class="punctuation">][]</span><span class="keyword type">string</span><span class="punctuation">)</span>

        <span class="name other">stats</span><span class="punctuation">.</span><span class="name other">StuffFound</span> <span class="punctuation">=</span> <span class="literal number integer">0</span> <span class="comment single">// count for stuff
</span>
        <span class="comment single">// grab the hostname of the endpoint
</span>        <span class="keyword">if</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">.</span><span class="name other">GetHostname</span> <span class="punctuation">{</span>
                <span class="name other">hostname</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">os</span><span class="punctuation">.</span><span class="name other">Hostname</span><span class="punctuation">()</span>
                <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
                <span class="punctuation">}</span>
                <span class="name other">el</span><span class="punctuation">.</span><span class="name other">Hostname</span> <span class="punctuation">=</span> <span class="name other">hostname</span>
                <span class="name other">stats</span><span class="punctuation">.</span><span class="name other">StuffFound</span><span class="operator">++</span>
        <span class="punctuation">}</span>

        <span class="comment single">// grab the local ip addresses
</span>        <span class="keyword">if</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">.</span><span class="name other">GetAddresses</span> <span class="punctuation">{</span>
                <span class="name other">addresses</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">net</span><span class="punctuation">.</span><span class="name other">InterfaceAddrs</span><span class="punctuation">()</span>
                <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
                <span class="punctuation">}</span>
                <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">addr</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">addresses</span> <span class="punctuation">{</span>
                        <span class="keyword">if</span> <span class="name other">addr</span><span class="punctuation">.</span><span class="name other">String</span><span class="punctuation">()</span> <span class="operator">==</span> <span class="literal string">&quot;127.0.0.1/8&quot;</span> <span class="operator">||</span> <span class="name other">addr</span><span class="punctuation">.</span><span class="name other">String</span><span class="punctuation">()</span> <span class="operator">==</span> <span class="literal string">&quot;::1/128&quot;</span> <span class="punctuation">{</span>
                                <span class="keyword">continue</span>
                        <span class="punctuation">}</span>
                        <span class="name other">el</span><span class="punctuation">.</span><span class="name other">Addresses</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">el</span><span class="punctuation">.</span><span class="name other">Addresses</span><span class="punctuation">,</span> <span class="name other">addr</span><span class="punctuation">.</span><span class="name other">String</span><span class="punctuation">())</span>
                        <span class="name other">stats</span><span class="punctuation">.</span><span class="name other">StuffFound</span><span class="operator">++</span>
                <span class="punctuation">}</span>
        <span class="punctuation">}</span>

        <span class="comment single">// look up a host
</span>        <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">host</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Parameters</span><span class="punctuation">.</span><span class="name other">LookupHost</span> <span class="punctuation">{</span>
                <span class="name other">addrs</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">net</span><span class="punctuation">.</span><span class="name other">LookupHost</span><span class="punctuation">(</span><span class="name other">host</span><span class="punctuation">)</span>
                <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                        <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
                <span class="punctuation">}</span>
                <span class="name other">el</span><span class="punctuation">.</span><span class="name other">LookedUpHost</span><span class="punctuation">[</span><span class="name other">host</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="name other">addrs</span>
        <span class="punctuation">}</span>

        <span class="comment single">// marshal the results into a json string
</span>        <span class="operator">*</span><span class="name other">out</span> <span class="punctuation">=</span> <span class="name other">r</span><span class="punctuation">.</span><span class="name other">buildResults</span><span class="punctuation">(</span><span class="name other">el</span><span class="punctuation">,</span> <span class="name other">stats</span><span class="punctuation">)</span>
        <span class="operator">*</span><span class="name other">moduleDone</span> <span class="operator">&lt;-</span> <span class="keyword constant">true</span>
        <span class="keyword">return</span> <span class="keyword constant">nil</span>
<span class="punctuation">}</span>

<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">buildResults</span><span class="punctuation">(</span><span class="name other">el</span> <span class="name other">elements</span><span class="punctuation">,</span> <span class="name other">stats</span> <span class="name other">statistics</span><span class="punctuation">)</span> <span class="keyword type">string</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Errors</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="literal number integer">0</span> <span class="punctuation">{</span>
                <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Success</span> <span class="punctuation">=</span> <span class="keyword constant">true</span>
        <span class="punctuation">}</span>
        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Elements</span> <span class="punctuation">=</span> <span class="name other">el</span>
        <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">Statistics</span> <span class="punctuation">=</span> <span class="name other">stats</span>
        <span class="keyword">if</span> <span class="name other">stats</span><span class="punctuation">.</span><span class="name other">StuffFound</span> <span class="punctuation">&gt;</span> <span class="literal number integer">0</span> <span class="punctuation">{</span>
                <span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">.</span><span class="name other">FoundAnything</span> <span class="punctuation">=</span> <span class="keyword constant">true</span>
        <span class="punctuation">}</span>
        <span class="name other">jsonOutput</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="operator">:=</span> <span class="name other">json</span><span class="punctuation">.</span><span class="name other">Marshal</span><span class="punctuation">(</span><span class="name other">r</span><span class="punctuation">.</span><span class="name other">Results</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="keyword">return</span> <span class="name builtin">string</span><span class="punctuation">(</span><span class="name other">jsonOutput</span><span class="punctuation">[:])</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="printing-results">
<h2><a class="toc-backref" href="#id25">2.5&nbsp;&nbsp;&nbsp;Printing results</a></h2>
<p>Printing results is needed to visualize module results efficiently. Nobody
wants to read raw json, especially when querying thousands of agents at once.</p>
<p>The function below receives a <tt class="docutils literal">modules.Result</tt> struct that need to be further
analyzed to access the <tt class="docutils literal">elements</tt> and <tt class="docutils literal">statistics</tt> types. Because these types
are specific to the module, and not known to MIG, they need to be accessed
using <tt class="docutils literal">result.GetElements</tt> and <tt class="docutils literal">result.GetStatistics</tt>.</p>
<p>The rest of the code simply goes through the values and pretty-prints them into
the <tt class="docutils literal">prints</tt> array of strings.</p>
<pre class="code go literal-block">
<span class="keyword declaration">func</span> <span class="punctuation">(</span><span class="name other">r</span> <span class="operator">*</span><span class="name other">run</span><span class="punctuation">)</span> <span class="name other">PrintResults</span><span class="punctuation">(</span><span class="name other">result</span> <span class="name other">modules</span><span class="punctuation">.</span><span class="name other">Result</span><span class="punctuation">,</span> <span class="name other">matchOnly</span> <span class="keyword type">bool</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name other">prints</span> <span class="punctuation">[]</span><span class="keyword type">string</span><span class="punctuation">,</span> <span class="name other">err</span> <span class="keyword type">error</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword declaration">var</span> <span class="punctuation">(</span>
                <span class="name other">el</span>    <span class="name other">elements</span>
                <span class="name other">stats</span> <span class="name other">statistics</span>
        <span class="punctuation">)</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">GetElements</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">el</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="name other">el</span><span class="punctuation">.</span><span class="name other">Hostname</span> <span class="operator">!=</span> <span class="literal string">&quot;&quot;</span> <span class="punctuation">{</span>
                <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;hostname is %s&quot;</span><span class="punctuation">,</span> <span class="name other">el</span><span class="punctuation">.</span><span class="name other">Hostname</span><span class="punctuation">))</span>
        <span class="punctuation">}</span>
        <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">addr</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">el</span><span class="punctuation">.</span><span class="name other">Addresses</span> <span class="punctuation">{</span>
                <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;address is %s&quot;</span><span class="punctuation">,</span> <span class="name other">addr</span><span class="punctuation">))</span>
        <span class="punctuation">}</span>
        <span class="keyword">for</span> <span class="name other">host</span><span class="punctuation">,</span> <span class="name other">addrs</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">el</span><span class="punctuation">.</span><span class="name other">LookedUpHost</span> <span class="punctuation">{</span>
                <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">addr</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">addrs</span> <span class="punctuation">{</span>
                        <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;lookedup host %s has IP %s&quot;</span><span class="punctuation">,</span> <span class="name other">host</span><span class="punctuation">,</span> <span class="name other">addr</span><span class="punctuation">))</span>
                <span class="punctuation">}</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="name other">matchOnly</span> <span class="punctuation">{</span>
                <span class="keyword">return</span>
        <span class="punctuation">}</span>
        <span class="keyword">for</span> <span class="name other">_</span><span class="punctuation">,</span> <span class="name other">e</span> <span class="operator">:=</span> <span class="keyword">range</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">Errors</span> <span class="punctuation">{</span>
                <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;error: %v&quot;</span><span class="punctuation">,</span> <span class="name other">e</span><span class="punctuation">))</span>
        <span class="punctuation">}</span>
        <span class="name other">err</span> <span class="punctuation">=</span> <span class="name other">result</span><span class="punctuation">.</span><span class="name other">GetStatistics</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="name other">stats</span><span class="punctuation">)</span>
        <span class="keyword">if</span> <span class="name other">err</span> <span class="operator">!=</span> <span class="keyword constant">nil</span> <span class="punctuation">{</span>
                <span class="name builtin">panic</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">)</span>
        <span class="punctuation">}</span>
        <span class="name other">prints</span> <span class="punctuation">=</span> <span class="name builtin">append</span><span class="punctuation">(</span><span class="name other">prints</span><span class="punctuation">,</span> <span class="name other">fmt</span><span class="punctuation">.</span><span class="name other">Sprintf</span><span class="punctuation">(</span><span class="literal string">&quot;stat: %d stuff found&quot;</span><span class="punctuation">,</span> <span class="name other">stats</span><span class="punctuation">.</span><span class="name other">StuffFound</span><span class="punctuation">))</span>
        <span class="keyword">return</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="creating-parameters">
<h2><a class="toc-backref" href="#id26">2.6&nbsp;&nbsp;&nbsp;Creating parameters</a></h2>
<p>to be added...</p>
</div>
</div>
</div>
</body>
</html>
